# =============================================================
# CI Pipeline â€” GitHub Actions
# IntegraciÃ³n Continua: instalar â†’ lint â†’ test â†’ build Docker
# Dispara en: push y pull_request a las ramas main y develop
# =============================================================

name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Cancelar ejecuciones anteriores del mismo PR/branch (ahorra minutos)
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â”€â”€ Job 1: Lint â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: ðŸ” Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      - name: Ejecutar ESLint
        run: npm run lint

  # â”€â”€ Job 2: Test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: ðŸ§ª Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      - name: Ejecutar tests con cobertura
        run: npm test

      - name: Subir reporte de cobertura
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  # â”€â”€ Job 3: Build Docker (verifica Dockerfile) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: ðŸ³ Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build de imagen Docker (sin push)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: actividadu2lab:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # Usa el stage 'production' (los tests corren en stage 'build')
          target: production

      - name: Resumen del pipeline
        run: |
          echo "## âœ… CI completado exitosamente" >> $GITHUB_STEP_SUMMARY
          echo "| Paso | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | âœ… OK |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | âœ… OK |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | âœ… OK |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
