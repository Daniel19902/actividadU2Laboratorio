# =============================================================
# CD Pipeline â€” GitHub Actions
# Entrega Continua: build â†’ push GHCR â†’ deploy agnÃ³stico
# Dispara en: push a main (despuÃ©s de que CI pase)
# =============================================================


name: CD Pipeline

on:
  push:
    branches: [main]
  # Permite ejecutar manualmente desde la UI de GitHub Actions
  workflow_dispatch:
    inputs:
      environment:
        description: 'Entorno de despliegue'
        required: true
        default: 'production'
        type: choice
        options: [production, staging]

# Solo una ejecuciÃ³n de CD activa a la vez por rama
concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false

env:
  REGISTRY: docker.io
  # Repositorio Docker Hub (DOCKERHUB_USERNAME/repo)
  IMAGE_NAME: TU_USUARIO_DOCKERHUB/actividadu2laboratorio

jobs:
  # â”€â”€ Job 1: Build y Push a Docker Hub â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-and-push:
    name: ðŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login en Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extraer metadatos (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=sha,prefix=sha-,format=short
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build y Push de imagen Docker
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          target: production
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # â”€â”€ Job 2: Deploy (agnÃ³stico de entorno) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: ðŸš€ Deploy
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ vars.APP_URL }}

    steps:
      - name: Checkout del cÃ³digo
        uses: actions/checkout@v4

      # â”€â”€ OpciÃ³n A: Despliegue por SSH (Docker Compose remoto) â”€â”€
      # Descomenta este bloque si tu entorno de producciÃ³n usa Docker/Compose en un VPS.
      # Requiere secrets: DEPLOY_HOST, DEPLOY_USER, DEPLOY_KEY
      #
      # - name: Deploy via SSH
      #   uses: appleboy/ssh-action@v1.0.3
      #   with:
      #     host: ${{ secrets.DEPLOY_HOST }}
      #     username: ${{ secrets.DEPLOY_USER }}
      #     key: ${{ secrets.DEPLOY_KEY }}
      #     script: |
      #       docker pull ${{ needs.build-and-push.outputs.image-tag }}
      #       docker stop actividadu2lab-app || true
      #       docker rm actividadu2lab-app || true
      #       docker run -d \
      #         --name actividadu2lab-app \
      #         --restart unless-stopped \
      #         -p 3000:3000 \
      #         -e NODE_ENV=production \
      #         ${{ needs.build-and-push.outputs.image-tag }}

      # â”€â”€ OpciÃ³n B: Despliegue en Kubernetes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Descomenta si usas Kubernetes (kubectl + kubeconfig secret).
      # Requiere secret: KUBE_CONFIG
      #
      # - name: Set up kubectl
      #   uses: azure/setup-kubectl@v3
      #
      # - name: Deploy en Kubernetes
      #   env:
      #     KUBECONFIG_DATA: ${{ secrets.KUBE_CONFIG }}
      #   run: |
      #     echo "$KUBECONFIG_DATA" | base64 -d > /tmp/kubeconfig
      #     export KUBECONFIG=/tmp/kubeconfig
      #     kubectl set image deployment/actividadu2lab \
      #       app=${{ needs.build-and-push.outputs.image-tag }}
      #     kubectl rollout status deployment/actividadu2lab

      # â”€â”€ OpciÃ³n C (ACTIVA): SimulaciÃ³n / Deploy genÃ©rico â”€â”€â”€â”€â”€â”€â”€
      # Reemplaza este step por la opciÃ³n A o B segÃºn tu infraestructura.
      - name: Deploy (simulaciÃ³n â€” adaptar segÃºn infraestructura)
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image-tag }}
          DEPLOY_ENV: ${{ github.event.inputs.environment || 'production' }}
        run: |
          echo "ðŸš€ Desplegando imagen: $IMAGE_TAG"
          echo "ðŸŒ Entorno destino: $DEPLOY_ENV"
          echo ""
          echo "Para activar el despliegue real:"
          echo "  â€¢ SSH/Docker â†’ descomenta OpciÃ³n A y configura DEPLOY_HOST, DEPLOY_USER, DEPLOY_KEY"
          echo "  â€¢ Kubernetes â†’ descomenta OpciÃ³n B y configura KUBE_CONFIG"
          echo ""
          echo "âœ… Deploy completado para commit ${{ github.sha }}"

      - name: Resumen del pipeline CD
        run: |
          echo "## ðŸš€ CD completado" >> $GITHUB_STEP_SUMMARY
          echo "| Campo | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Imagen | \`${{ needs.build-and-push.outputs.image-tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Digest | \`${{ needs.build-and-push.outputs.image-digest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Entorno | \`${{ github.event.inputs.environment || 'production' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
